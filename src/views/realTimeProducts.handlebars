<h1>{{title}}</h1>

<div id="errorAlert" class="alert alert-error" style="display: none;">
  <strong>Error:</strong> <span id="errorMessage"></span>
</div>

<div id="successAlert" class="alert alert-success" style="display: none;">
  <strong>√âxito:</strong> <span id="successMessage"></span>
</div>

<!-- Formulario para crear productos -->
<div class="form-container">
  <h2>‚ûï Agregar Productos</h2>
  <form id="productForm">
    <div class="form-group">
      <label for="title">T√≠tulo *</label>
      <input type="text" id="title" name="title" required>
    </div>
    
    <div class="form-group">
      <label for="description">Descripci√≥n *</label>
      <textarea id="description" name="description" required></textarea>
    </div>
    
    <div class="form-group">
      <label for="code">C√≥digo *</label>
      <input type="text" id="code" name="code" required>
    </div>
    
    <div class="form-group">
      <label for="price">Precio *</label>
      <input type="number" id="price" name="price" step="0.01" min="0" required>
    </div>
    
    <div class="form-group">
      <label for="stock">Stock *</label>
      <input type="number" id="stock" name="stock" min="0" required>
    </div>
    
    <div class="form-group">
      <label for="category">Categor√≠a *</label>
      <input type="text" id="category" name="category" required>
    </div>
    
    <div class="form-group">
      <label for="thumbnails">Im√°genes (URLs separadas por coma)</label>
      <input type="text" id="thumbnails" name="thumbnails" placeholder="http://imagen1.jpg, http://imagen2.jpg">
    </div>
    
    <button type="submit">Crear Producto</button>
  </form>
</div>

<!-- Lista de productos -->
<h2 style="margin-top: 30px; margin-bottom: 15px; color: #333;">üì¶ Productos Disponibles</h2>
<div id="productList" class="product-grid">
  <!-- Los productos se cargar√°n aqu√≠ din√°micamente -->
</div>

<div id="noProducts" style="display: none;" class="alert alert-success">
  <p>No hay productos en la base de datos.</p>
  <p>Usa el formulario de arriba para agregar el primer producto.</p>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();
  
  // Elementos del DOM
  const productForm = document.getElementById('productForm');
  const productList = document.getElementById('productList');
  const noProducts = document.getElementById('noProducts');
  const errorAlert = document.getElementById('errorAlert');
  const errorMessage = document.getElementById('errorMessage');
  const successAlert = document.getElementById('successAlert');
  const successMessage = document.getElementById('successMessage');

  // Funciones de alertas
  function showError(message) {
    errorMessage.textContent = message;
    errorAlert.style.display = 'block';
    successAlert.style.display = 'none';
    setTimeout(() => {
      errorAlert.style.display = 'none';
    }, 5000);
  }

  function showSuccess(message) {
    successMessage.textContent = message;
    successAlert.style.display = 'block';
    errorAlert.style.display = 'none';
    setTimeout(() => {
      successAlert.style.display = 'none';
    }, 3000);
  }

  // Renderizar productos
  function renderProducts(products) {
    if (!products || products.length === 0) {
      productList.innerHTML = '';
      noProducts.style.display = 'block';
      return;
    }

    noProducts.style.display = 'none';
    productList.innerHTML = products.map(product => `
      <div class="product-card">
        ${product.thumbnails && product.thumbnails[0] ? 
          `<div class="product-image">
            <img src="${product.thumbnails[0]}" alt="${product.title}" onerror="this.src='https://via.placeholder.com/280x200?text=Sin+Imagen'">
          </div>` : ''}
        <h3>${product.title}</h3>
        <p><strong>C√≥digo:</strong> ${product.code}</p>
        <p><strong>Descripci√≥n:</strong> ${product.description}</p>
        <p class="price">$${product.price}</p>
        <p><strong>Stock:</strong> ${product.stock} unidades</p>
        <p><strong>Categor√≠a:</strong> ${product.category}</p>
        <span class="status ${product.status ? 'available' : 'unavailable'}">
          ${product.status ? 'Disponible' : 'No disponible'}
        </span>
        ${product.thumbnails && product.thumbnails.length > 0 ? 
          `<p><strong>Im√°genes:</strong> ${product.thumbnails.length}</p>` : ''}
        <p style="font-size: 0.8em; color: #999; margin-top: 10px;">
          <strong>ID:</strong> ${product._id || product.id}
        </p>
        <button class="delete" onclick="deleteProduct('${product._id || product.id}')">
          üóëÔ∏è Eliminar
        </button>
      </div>
    `).join('');
  }

  // Escuchar productos del servidor
  socket.on('products', (products) => {
    console.log('Productos recibidos:', products);
    renderProducts(products);
  });

  // Escuchar errores del servidor
  socket.on('error', (message) => {
    console.error('Error del servidor:', message);
    showError(message);
  });

  // Enviar formulario para crear producto
  productForm.addEventListener('submit', (e) => {
    e.preventDefault();
    
    const formData = new FormData(productForm);
    const productData = {
      title: formData.get('title'),
      description: formData.get('description'),
      code: formData.get('code'),
      price: parseFloat(formData.get('price')),
      stock: parseInt(formData.get('stock')),
      category: formData.get('category'),
      status: true
    };

    // Procesar thumbnails
    const thumbnailsInput = formData.get('thumbnails');
    if (thumbnailsInput && thumbnailsInput.trim()) {
      productData.thumbnails = thumbnailsInput.split(',').map(url => url.trim()).filter(url => url);
    }

    console.log('Enviando producto:', productData);
    socket.emit('createProduct', productData);
    
    // Limpiar formulario
    productForm.reset();
    showSuccess('Producto creado exitosamente');
  });

  // Funci√≥n para eliminar producto
  function deleteProduct(id) {
    if (confirm('¬øEst√°s seguro de que deseas eliminar este producto?')) {
      console.log('Eliminando producto:', id);
      socket.emit('deleteProduct', id);
      showSuccess('Producto eliminado exitosamente');
    }
  }

  // Manejar conexi√≥n
  socket.on('connect', () => {
    console.log('Conectado al servidor WebSocket');
  });

  socket.on('disconnect', () => {
    console.log('Desconectado del servidor WebSocket');
    showError('Conexi√≥n perdida con el servidor');
  });
</script>
