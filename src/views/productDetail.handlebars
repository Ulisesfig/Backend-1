<div class="product-detail-container">
  {{#if error}}
    <div class="alert alert-error">
      <strong>Error:</strong> {{error}}
    </div>
    <a href="/products" class="btn-back">‚Üê Volver a productos</a>
  {{else}}
    <div class="product-detail">
      <div class="product-detail-image">
        {{#if product.thumbnails.length}}
          {{#each product.thumbnails}}
            {{#if @first}}
              <img src="{{this}}" alt="{{../product.title}}" onerror="this.src='https://via.placeholder.com/400x400?text=Sin+Imagen'">
            {{/if}}
          {{/each}}
        {{else}}
          <img src="https://via.placeholder.com/400x400?text=Sin+Imagen" alt="Sin imagen">
        {{/if}}
      </div>
      
      <div class="product-detail-info">
        <h1>{{product.title}}</h1>
        
        <div class="product-meta">
          <span class="product-code">C√≥digo: {{product.code}}</span>
          <span class="product-category">Categor√≠a: {{product.category}}</span>
        </div>
        
        <p class="product-description">{{product.description}}</p>
        
        <div class="product-price-section">
          <p class="product-price">${{product.price}}</p>
          <p class="product-stock">
            {{#if product.status}}
              <span class="status available">‚úì Disponible</span>
              <span>Stock: {{product.stock}} unidades</span>
            {{else}}
              <span class="status unavailable">‚úó No disponible</span>
            {{/if}}
          </p>
        </div>
        
        <div class="product-actions">
          {{#if product.status}}
            <button class="btn-add-cart-large" onclick="addToCart('{{product._id}}')">
              üõí Agregar al carrito
            </button>
          {{else}}
            <button class="btn-add-cart-large" disabled>
              Producto no disponible
            </button>
          {{/if}}
          <a href="/products" class="btn-back">‚Üê Volver a productos</a>
        </div>
      </div>
    </div>
  {{/if}}
</div>

<style>
  .product-detail-container {
    max-width: 1200px;
    margin: 0 auto;
  }
  .product-detail {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 40px;
    margin-top: 30px;
  }
  @media (max-width: 768px) {
    .product-detail {
      grid-template-columns: 1fr;
    }
  }
  .product-detail-image {
    width: 100%;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  .product-detail-image img {
    width: 100%;
    height: auto;
    object-fit: cover;
  }
  .product-detail-info {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }
  .product-detail-info h1 {
    font-size: 2.5em;
    color: #1b263b;
    margin: 0;
  }
  .product-meta {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    font-size: 0.9em;
    color: #666;
  }
  .product-description {
    font-size: 1.1em;
    line-height: 1.6;
    color: #444;
  }
  .product-price-section {
    border-top: 2px solid #eee;
    border-bottom: 2px solid #eee;
    padding: 20px 0;
  }
  .product-price {
    font-size: 2.5em;
    color: #0d47a1;
    font-weight: bold;
    margin: 0 0 10px 0;
  }
  .product-stock {
    display: flex;
    gap: 15px;
    align-items: center;
    font-size: 1.1em;
  }
  .product-actions {
    display: flex;
    flex-direction: column;
    gap: 15px;
  }
  .btn-add-cart-large {
    padding: 15px 30px;
    background: #4caf50;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 1.2em;
    cursor: pointer;
    transition: background 0.3s;
  }
  .btn-add-cart-large:hover:not(:disabled) {
    background: #45a049;
  }
  .btn-add-cart-large:disabled {
    background: #ccc;
    cursor: not-allowed;
  }
  .btn-back {
    padding: 12px 24px;
    background: #666;
    color: white;
    text-decoration: none;
    border-radius: 8px;
    text-align: center;
    transition: background 0.3s;
  }
  .btn-back:hover {
    background: #555;
  }
  
  /* Notificaciones Toast */
  .toast {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    border-radius: 8px;
    color: white;
    font-weight: bold;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 10000;
    opacity: 0;
    transform: translateY(-20px);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    min-width: 300px;
  }
  .toast.show {
    opacity: 1;
    transform: translateY(0);
  }
  .toast-success {
    background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
  }
  .toast-error {
    background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
  }
</style>

<script>
  let currentCartId = localStorage.getItem('cartId');

  // Funci√≥n para mostrar notificaciones toast
  function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.innerHTML = `
      <span>${message}</span>
      <button onclick="this.parentElement.remove()" style="margin-left: 10px; background: none; border: none; color: white; cursor: pointer; font-size: 1.2em;">&times;</button>
    `;
    document.body.appendChild(toast);
    
    setTimeout(() => toast.classList.add('show'), 100);
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }

  async function addToCart(productId) {
    // Preguntar antes de agregar
    if (!confirm('¬øDesea agregar este producto al carrito?')) {
      return;
    }
    
    try {
      if (!currentCartId) {
        const createResponse = await fetch('/api/carts', {
          method: 'POST'
        });
        const cartData = await createResponse.json();
        currentCartId = cartData.payload._id;
        localStorage.setItem('cartId', currentCartId);
      }

      const response = await fetch(`/api/carts/${currentCartId}/product/${productId}`, {
        method: 'POST'
      });
      
      if (response.ok) {
        showToast('‚úÖ Producto agregado al carrito exitosamente', 'success');
        setTimeout(() => {
          if (confirm('¬øDesea ver su carrito ahora?')) {
            window.location.href = `/carts/${currentCartId}`;
          }
        }, 1000);
      } else {
        showToast('‚ùå Error al agregar producto', 'error');
      }
    } catch (error) {
      console.error('Error:', error);
      showToast('‚ùå Error al agregar producto', 'error');
    }
  }
</script>
