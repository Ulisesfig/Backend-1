<h1>{{title}}</h1>

{{#if error}}
  <div class="alert alert-error">
    <strong>Error:</strong> {{error}}
  </div>
{{/if}}

<!-- Filtros y ordenamiento -->
<div class="filters-container">
  <form method="GET" action="/products" class="filters-form">
    <div class="filter-group">
      <label for="query">Categor√≠a:</label>
      <input type="text" id="query" name="query" placeholder="Ej: Redes" value="{{query}}">
    </div>
    
    <div class="filter-group">
      <label for="sort">Ordenar por precio:</label>
      <select id="sort" name="sort">
        <option value="">Sin ordenar</option>
        <option value="asc">Menor a mayor</option>
        <option value="desc">Mayor a menor</option>
      </select>
    </div>
    
    <div class="filter-group">
      <label for="limit">Por p√°gina:</label>
      <select id="limit" name="limit">
        <option value="10">10</option>
        <option value="20">20</option>
        <option value="50">50</option>
      </select>
    </div>
    
    <button type="submit">Filtrar</button>
    <a href="/products" class="btn-reset">Limpiar</a>
  </form>
</div>

{{#if products.length}}
  <div class="product-grid">
    {{#each products}}
      <div class="product-card">
        {{#if this.thumbnails.length}}
          {{#each this.thumbnails}}
            {{#if @first}}
              <div class="product-image">
                <img src="{{this}}" alt="Imagen del producto" onerror="this.src='https://via.placeholder.com/280x200?text=Sin+Imagen'">
              </div>
            {{/if}}
          {{/each}}
        {{/if}}
        <h3>{{this.title}}</h3>
        <p><strong>Categor√≠a:</strong> {{this.category}}</p>
        <p class="price">${{this.price}}</p>
        <p><strong>Stock:</strong> {{this.stock}} unidades</p>
        {{#if this.status}}
          <span class="status available">Disponible</span>
        {{else}}
          <span class="status unavailable">No disponible</span>
        {{/if}}
        <div class="product-actions">
          <a href="/products/{{this._id}}" class="btn-detail">Ver detalle</a>
          <button class="btn-add-cart" onclick="addToCart('{{this._id}}')">
            üõí Agregar al carrito
          </button>
        </div>
      </div>
    {{/each}}
  </div>

  <!-- Paginaci√≥n -->
  <div class="pagination">
    {{#if hasPrevPage}}
      <a href="{{prevLink}}" class="page-link">‚Üê Anterior</a>
    {{else}}
      <span class="page-link disabled">‚Üê Anterior</span>
    {{/if}}
    
    <span class="page-info">P√°gina {{page}} de {{totalPages}}</span>
    
    {{#if hasNextPage}}
      <a href="{{nextLink}}" class="page-link">Siguiente ‚Üí</a>
    {{else}}
      <span class="page-link disabled">Siguiente ‚Üí</span>
    {{/if}}
  </div>
{{else}}
  <div class="alert alert-success">
    <p>No hay productos disponibles.</p>
  </div>
{{/if}}

<style>
  .filters-container {
    background: #f5f5f5;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 30px;
  }
  .filters-form {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    align-items: end;
  }
  .filter-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
  }
  .filter-group label {
    font-size: 0.9em;
    color: #555;
    font-weight: bold;
  }
  .filter-group input,
  .filter-group select {
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 5px;
  }
  .btn-reset {
    padding: 8px 16px;
    background: #666;
    color: white;
    text-decoration: none;
    border-radius: 5px;
    display: inline-block;
  }
  .product-actions {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 15px;
  }
  .btn-detail {
    padding: 8px 16px;
    background: #1b263b;
    color: white;
    text-decoration: none;
    border-radius: 5px;
    text-align: center;
  }
  .btn-detail:hover {
    background: #0d47a1;
  }
  .btn-add-cart {
    padding: 8px 16px;
    background: #4caf50;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }
  .btn-add-cart:hover {
    background: #45a049;
  }
  .pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px;
    margin-top: 30px;
    padding: 20px;
  }
  .page-link {
    padding: 10px 20px;
    background: #1b263b;
    color: white;
    text-decoration: none;
    border-radius: 5px;
  }
  .page-link:hover {
    background: #0d47a1;
  }
  .page-link.disabled {
    background: #ccc;
    cursor: not-allowed;
  }
  .page-info {
    font-weight: bold;
    color: #1b263b;
  }
  
  /* Notificaciones Toast */
  .toast {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    border-radius: 8px;
    color: white;
    font-weight: bold;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 10000;
    opacity: 0;
    transform: translateY(-20px);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    min-width: 300px;
  }
  .toast.show {
    opacity: 1;
    transform: translateY(0);
  }
  .toast-success {
    background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
  }
  .toast-error {
    background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
  }
</style>

<script>
  // ID del carrito guardado en localStorage
  let currentCartId = localStorage.getItem('cartId');

  // Funci√≥n para mostrar notificaciones toast
  function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.innerHTML = `
      <span>${message}</span>
      <button onclick="this.parentElement.remove()" style="margin-left: 10px; background: none; border: none; color: white; cursor: pointer; font-size: 1.2em;">&times;</button>
    `;
    document.body.appendChild(toast);
    
    setTimeout(() => toast.classList.add('show'), 100);
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }

  async function addToCart(productId) {
    // Preguntar antes de agregar
    if (!confirm('¬øDesea agregar este producto al carrito?')) {
      return;
    }
    
    try {
      // Si no hay carrito, crear uno
      if (!currentCartId) {
        const createResponse = await fetch('/api/carts', {
          method: 'POST'
        });
        const cartData = await createResponse.json();
        currentCartId = cartData.payload._id;
        localStorage.setItem('cartId', currentCartId);
      }

      // Agregar producto al carrito
      const response = await fetch(`/api/carts/${currentCartId}/product/${productId}`, {
        method: 'POST'
      });
      
      if (response.ok) {
        showToast('‚úÖ Producto agregado al carrito exitosamente', 'success');
        // Preguntar si quiere ver el carrito despu√©s de mostrar el √©xito
        setTimeout(() => {
          if (confirm('¬øDesea ver su carrito ahora?')) {
            window.location.href = `/carts/${currentCartId}`;
          }
        }, 1000);
      } else {
        showToast('‚ùå Error al agregar producto', 'error');
      }
    } catch (error) {
      console.error('Error:', error);
      showToast('‚ùå Error al agregar producto', 'error');
    }
  }
</script>
